---
- name: Install MongoDB on localhost.
  hosts: db_servers
  gather_facts: true
  become: true
  tasks:
    - name: Create repo file for mongodb-enterprise.
      ansible.builtin.template:
        src: mongodb-enterprise.repo.j2
        dest: "/etc/yum.repos.d/mongodb-enterprise-{{ mongodb_version }}.repo"
        owner: root
        group: root
        mode: '0644'

    - name: Install mongodb-enterprise.
      ansible.builtin.package:
        name: mongodb-enterprise
        state: present

    - name: Start mongod service.
      ansible.builtin.service:
        name: mongod
        state: started
        enabled: true

    - name: Check mongod status
      ansible.builtin.systemd:
        name: mongod
      register: mongod_check
      changed_when: false
      failed_when: mongod_check.status.ActiveState != 'active'

    - name: Print mongod status for verification.
      ansible.builtin.debug:
        var: mongod_check.ActiveState

    - name: Check mongod version.
      ansible.builtin.command: mongod --version
      register: mongod_version
      changed_when: false
      failed_when: mongodb_version not in mongod_version.stdout

    - name: Print mongod version for verification.
      ansible.builtin.debug:
        var: mongod_version.stdout_lines

    - name: Verify MongoDB Enterprise Edition is ready
      ansible.builtin.wait_for:
        path: /var/log/mongodb/mongod.log
        search_regex: 'Waiting for connections'
        timeout: 30

    - name: Congratulations!
      ansible.builtin.debug:
        msg: "MongoDB installation complete."
